707c7a7d8b2f2540e549eb5886eda081
'use strict';var _lodash = require('lodash');var _lodash2 = _interopRequireDefault(_lodash);
var _triggers_panel_ctrl = require('../triggers_panel_ctrl');function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { default: obj };}

// import { create } from 'domain';

describe('TriggerPanelCtrl', function () {
  var ctx = {};
  var datasourceSrvMock = void 0,zabbixDSMock = void 0;
  var timeoutMock = function timeoutMock() {};
  var createPanelCtrl = void 0;

  beforeEach(function () {
    ctx = { scope: { panel: _triggers_panel_ctrl.PANEL_DEFAULTS } };
    zabbixDSMock = {
      replaceTemplateVars: function replaceTemplateVars() {},
      zabbix: {
        getTriggers: jest.fn().mockReturnValue([generateTrigger("1"), generateTrigger("1")]),
        getAcknowledges: jest.fn().mockReturnValue(Promise.resolve([])) } };



    datasourceSrvMock = {
      getMetricSources: function getMetricSources() {
        return [
        { meta: { id: 'alexanderzobnin-zabbix-datasource' }, value: {}, name: 'zabbix_default' },
        { meta: { id: 'alexanderzobnin-zabbix-datasource' }, value: {}, name: 'zabbix' },
        { meta: { id: 'graphite' }, value: {}, name: 'graphite' }];

      },
      get: function get() {return Promise.resolve(zabbixDSMock);} };

    createPanelCtrl = function createPanelCtrl() {return new _triggers_panel_ctrl.TriggerPanelCtrl(ctx.scope, {}, timeoutMock, datasourceSrvMock, {}, {}, {});};

    var getTriggersResp = [
    [
    createTrigger({
      triggerid: "1", lastchange: "1510000010", priority: 5, lastEvent: { eventid: "11" }, hosts: [{ maintenance_status: '1' }] }),

    createTrigger({
      triggerid: "2", lastchange: "1510000040", priority: 3, lastEvent: { eventid: "12" } })],


    [
    createTrigger({ triggerid: "3", lastchange: "1510000020", priority: 4, lastEvent: { eventid: "13" } }),
    createTrigger({ triggerid: "4", lastchange: "1510000030", priority: 2, lastEvent: { eventid: "14" } })]];



    // Simulate 2 data sources
    zabbixDSMock.zabbix.getTriggers = jest.fn().
    mockReturnValueOnce(getTriggersResp[0]).
    mockReturnValueOnce(getTriggersResp[1]);
    zabbixDSMock.zabbix.getAcknowledges = jest.fn().
    mockReturnValue(Promise.resolve([defaultEvent]));

    ctx.panelCtrl = createPanelCtrl();
  });

  describe('When adding new panel', function () {
    it('should suggest all zabbix data sources', function () {
      ctx.scope.panel = {};
      var panelCtrl = createPanelCtrl();
      expect(panelCtrl.available_datasources).toEqual([
      'zabbix_default', 'zabbix']);

    });

    it('should load first zabbix data source as default', function () {
      ctx.scope.panel = {};
      var panelCtrl = createPanelCtrl();
      expect(panelCtrl.panel.datasources).toEqual([
      'zabbix_default']);

    });
  });

  describe('When refreshing panel', function () {
    beforeEach(function () {
      ctx.scope.panel.datasources = ['zabbix_default', 'zabbix'];
      ctx.scope.panel.targets = {
        'zabbix_default': _triggers_panel_ctrl.DEFAULT_TARGET,
        'zabbix': _triggers_panel_ctrl.DEFAULT_TARGET };

      ctx.panelCtrl = createPanelCtrl();
    });

    it('should format triggers', function (done) {
      ctx.panelCtrl.onRefresh().then(function () {
        var formattedTrigger = _lodash2.default.find(ctx.panelCtrl.triggerList, { triggerid: "1" });
        expect(formattedTrigger.host).toBe('backend01');
        expect(formattedTrigger.hostTechName).toBe('backend01_tech');
        expect(formattedTrigger.datasource).toBe('zabbix_default');
        expect(formattedTrigger.severity).toBe('Disaster');
        expect(formattedTrigger.maintenance).toBe(true);
        expect(formattedTrigger.age).toBeTruthy();
        expect(formattedTrigger.lastchange).toBeTruthy();
        done();
      });
    });

    it('should sort triggers by time by default', function (done) {
      ctx.panelCtrl.onRefresh().then(function () {
        var trigger_ids = _lodash2.default.map(ctx.panelCtrl.triggerList, 'triggerid');
        expect(trigger_ids).toEqual([
        '2', '4', '3', '1']);

        done();
      });
    });

    it('should sort triggers by severity', function (done) {
      ctx.panelCtrl.panel.sortTriggersBy = { text: 'severity', value: 'priority' };
      ctx.panelCtrl.onRefresh().then(function () {
        var trigger_ids = _lodash2.default.map(ctx.panelCtrl.triggerList, 'triggerid');
        expect(trigger_ids).toEqual([
        '1', '3', '2', '4']);

        done();
      });
    });

    it('should add acknowledges to trigger', function (done) {
      ctx.panelCtrl.onRefresh().then(function () {
        var trigger = getTriggerById(1, ctx);
        expect(trigger.acknowledges).toHaveLength(1);
        expect(trigger.acknowledges[0].message).toBe("event ack");

        expect(getTriggerById(2, ctx).acknowledges).toBe(undefined);
        expect(getTriggerById(3, ctx).acknowledges).toBe(undefined);
        expect(getTriggerById(4, ctx).acknowledges).toBe(undefined);
        done();
      });
    });
  });

  describe('When formatting triggers', function () {
    beforeEach(function () {
      ctx.panelCtrl = createPanelCtrl();
    });

    it('should handle new lines in trigger description', function () {
      ctx.panelCtrl.setTriggerSeverity = jest.fn(function (trigger) {return trigger;});
      var trigger = { comments: "this is\ndescription" };
      var formattedTrigger = ctx.panelCtrl.formatTrigger(trigger);
      expect(formattedTrigger.comments).toBe("this is<br>description");
    });

    it('should format host name to display (default)', function (done) {
      ctx.panelCtrl.onRefresh().then(function () {
        var trigger = getTriggerById(1, ctx);
        var hostname = ctx.panelCtrl.formatHostName(trigger);
        expect(hostname).toBe('backend01');
        done();
      });
    });

    it('should format host name to display (tech name)', function (done) {
      ctx.panelCtrl.panel.hostField = false;
      ctx.panelCtrl.panel.hostTechNameField = true;
      ctx.panelCtrl.onRefresh().then(function () {
        var trigger = getTriggerById(1, ctx);
        var hostname = ctx.panelCtrl.formatHostName(trigger);
        expect(hostname).toBe('backend01_tech');
        done();
      });
    });

    it('should format host name to display (both tech and visible)', function (done) {
      ctx.panelCtrl.panel.hostField = true;
      ctx.panelCtrl.panel.hostTechNameField = true;
      ctx.panelCtrl.onRefresh().then(function () {
        var trigger = getTriggerById(1, ctx);
        var hostname = ctx.panelCtrl.formatHostName(trigger);
        expect(hostname).toBe('backend01 (backend01_tech)');
        done();
      });
    });

    it('should hide hostname if both visible and tech name checkboxes unset', function (done) {
      ctx.panelCtrl.panel.hostField = false;
      ctx.panelCtrl.panel.hostTechNameField = false;
      ctx.panelCtrl.onRefresh().then(function () {
        var trigger = getTriggerById(1, ctx);
        var hostname = ctx.panelCtrl.formatHostName(trigger);
        expect(hostname).toBe("");
        done();
      });
    });
  });

  describe('When formatting acknowledges', function () {
    beforeEach(function () {
      ctx.panelCtrl = createPanelCtrl();
    });

    it('should build proper user name', function () {
      var ack = {
        alias: 'alias', name: 'name', surname: 'surname' };


      var formatted = ctx.panelCtrl.formatAcknowledge(ack);
      expect(formatted.user).toBe('alias (name surname)');
    });

    it('should return empty name if it is not defined', function () {
      var formatted = ctx.panelCtrl.formatAcknowledge({});
      expect(formatted.user).toBe('');
    });
  });
});

var defaultTrigger = {
  "triggerid": "13565",
  "value": "1",
  "groups": [{ "groupid": "1", "name": "Backend" }],
  "hosts": [{ "host": "backend01_tech", "hostid": "10001", "maintenance_status": "0", "name": "backend01" }],
  "lastEvent": {
    "eventid": "11",
    "clock": "1507229064",
    "ns": "556202037",
    "acknowledged": "1",
    "value": "1",
    "object": "0",
    "source": "0",
    "objectid": "13565" },

  "tags": [],
  "lastchange": "1440259530",
  "priority": "2",
  "description": "Lack of free swap space on server",
  "comments": "It probably means that the systems requires\nmore physical memory.",
  "url": "https://host.local/path",
  "templateid": "0", "expression": "{13174}<50", "manual_close": "0", "correlation_mode": "0",
  "correlation_tag": "", "recovery_mode": "0", "recovery_expression": "", "state": "0", "status": "0",
  "flags": "0", "type": "0", "items": [], "error": "" };


var defaultEvent = {
  "eventid": "11",
  "acknowledges": [
  {
    "acknowledgeid": "185",
    "action": "0",
    "alias": "api",
    "clock": "1512382246",
    "eventid": "11",
    "message": "event ack",
    "name": "api",
    "surname": "user",
    "userid": "3" }],


  "clock": "1507229064",
  "ns": "556202037",
  "acknowledged": "1",
  "value": "1",
  "object": "0",
  "source": "0",
  "objectid": "1" };


function generateTrigger(id, timestamp, severity) {
  var trigger = _lodash2.default.cloneDeep(defaultTrigger);
  trigger.triggerid = id.toString();
  if (severity) {
    trigger.priority = severity.toString();
  }
  if (timestamp) {
    trigger.lastchange = timestamp;
  }
  return trigger;
}

function createTrigger(props) {
  var trigger = _lodash2.default.cloneDeep(defaultTrigger);
  trigger = _lodash2.default.merge(trigger, props);
  trigger.lastEvent.objectid = trigger.triggerid;
  return trigger;
}

function getTriggerById(id, ctx) {
  return _lodash2.default.find(ctx.panelCtrl.triggerList, { triggerid: id.toString() });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhbmVsX2N0cmwuc3BlYy5qcyJdLCJuYW1lcyI6WyJkZXNjcmliZSIsImN0eCIsImRhdGFzb3VyY2VTcnZNb2NrIiwiemFiYml4RFNNb2NrIiwidGltZW91dE1vY2siLCJjcmVhdGVQYW5lbEN0cmwiLCJiZWZvcmVFYWNoIiwic2NvcGUiLCJwYW5lbCIsIlBBTkVMX0RFRkFVTFRTIiwicmVwbGFjZVRlbXBsYXRlVmFycyIsInphYmJpeCIsImdldFRyaWdnZXJzIiwiamVzdCIsImZuIiwibW9ja1JldHVyblZhbHVlIiwiZ2VuZXJhdGVUcmlnZ2VyIiwiZ2V0QWNrbm93bGVkZ2VzIiwiUHJvbWlzZSIsInJlc29sdmUiLCJnZXRNZXRyaWNTb3VyY2VzIiwibWV0YSIsImlkIiwidmFsdWUiLCJuYW1lIiwiZ2V0IiwiVHJpZ2dlclBhbmVsQ3RybCIsImdldFRyaWdnZXJzUmVzcCIsImNyZWF0ZVRyaWdnZXIiLCJ0cmlnZ2VyaWQiLCJsYXN0Y2hhbmdlIiwicHJpb3JpdHkiLCJsYXN0RXZlbnQiLCJldmVudGlkIiwiaG9zdHMiLCJtYWludGVuYW5jZV9zdGF0dXMiLCJtb2NrUmV0dXJuVmFsdWVPbmNlIiwiZGVmYXVsdEV2ZW50IiwicGFuZWxDdHJsIiwiaXQiLCJleHBlY3QiLCJhdmFpbGFibGVfZGF0YXNvdXJjZXMiLCJ0b0VxdWFsIiwiZGF0YXNvdXJjZXMiLCJ0YXJnZXRzIiwiREVGQVVMVF9UQVJHRVQiLCJkb25lIiwib25SZWZyZXNoIiwidGhlbiIsImZvcm1hdHRlZFRyaWdnZXIiLCJfIiwiZmluZCIsInRyaWdnZXJMaXN0IiwiaG9zdCIsInRvQmUiLCJob3N0VGVjaE5hbWUiLCJkYXRhc291cmNlIiwic2V2ZXJpdHkiLCJtYWludGVuYW5jZSIsImFnZSIsInRvQmVUcnV0aHkiLCJ0cmlnZ2VyX2lkcyIsIm1hcCIsInNvcnRUcmlnZ2Vyc0J5IiwidGV4dCIsInRyaWdnZXIiLCJnZXRUcmlnZ2VyQnlJZCIsImFja25vd2xlZGdlcyIsInRvSGF2ZUxlbmd0aCIsIm1lc3NhZ2UiLCJ1bmRlZmluZWQiLCJzZXRUcmlnZ2VyU2V2ZXJpdHkiLCJjb21tZW50cyIsImZvcm1hdFRyaWdnZXIiLCJob3N0bmFtZSIsImZvcm1hdEhvc3ROYW1lIiwiaG9zdEZpZWxkIiwiaG9zdFRlY2hOYW1lRmllbGQiLCJhY2siLCJhbGlhcyIsInN1cm5hbWUiLCJmb3JtYXR0ZWQiLCJmb3JtYXRBY2tub3dsZWRnZSIsInVzZXIiLCJkZWZhdWx0VHJpZ2dlciIsInRpbWVzdGFtcCIsImNsb25lRGVlcCIsInRvU3RyaW5nIiwicHJvcHMiLCJtZXJnZSIsIm9iamVjdGlkIl0sIm1hcHBpbmdzIjoiYUFBQSxnQztBQUNBLDZEOztBQUVBOztBQUVBQSxTQUFTLGtCQUFULEVBQTZCLFlBQU07QUFDakMsTUFBSUMsTUFBTSxFQUFWO0FBQ0EsTUFBSUMsMEJBQUosQ0FBdUJDLHFCQUF2QjtBQUNBLE1BQUlDLGNBQWMsU0FBZEEsV0FBYyxHQUFNLENBQUUsQ0FBMUI7QUFDQSxNQUFJQyx3QkFBSjs7QUFFQUMsYUFBVyxZQUFNO0FBQ2ZMLFVBQU0sRUFBQ00sT0FBTyxFQUFDQyxPQUFPQyxtQ0FBUixFQUFSLEVBQU47QUFDQU4sbUJBQWU7QUFDYk8sMkJBQXFCLCtCQUFNLENBQUUsQ0FEaEI7QUFFYkMsY0FBUTtBQUNOQyxxQkFBYUMsS0FBS0MsRUFBTCxHQUFVQyxlQUFWLENBQTBCLENBQUNDLGdCQUFnQixHQUFoQixDQUFELEVBQXVCQSxnQkFBZ0IsR0FBaEIsQ0FBdkIsQ0FBMUIsQ0FEUDtBQUVOQyx5QkFBaUJKLEtBQUtDLEVBQUwsR0FBVUMsZUFBVixDQUEwQkcsUUFBUUMsT0FBUixDQUFnQixFQUFoQixDQUExQixDQUZYLEVBRkssRUFBZjs7OztBQVFBakIsd0JBQW9CO0FBQ2xCa0Isd0JBQWtCLDRCQUFNO0FBQ3RCLGVBQU87QUFDTCxVQUFFQyxNQUFNLEVBQUNDLElBQUksbUNBQUwsRUFBUixFQUFtREMsT0FBTyxFQUExRCxFQUE4REMsTUFBTSxnQkFBcEUsRUFESztBQUVMLFVBQUVI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STlCLFFBQUosRUFBYztBQUNaUSxZQUFRbEMsUUFBUixHQUFtQjBCLFNBQVM4QixRQUFULEVBQW5CO0FBQ0Q7QUFDRCxNQUFJRixTQUFKLEVBQWU7QUFDYnBCLFlBQVFuQyxVQUFSLEdBQXFCdUQsU0FBckI7QUFDRDtBQUNELFNBQU9wQixPQUFQO0FBQ0Q7O0FBRUQsU0FBU3JDLGFBQVQsQ0FBdUI0RCxLQUF2QixFQUE4QjtBQUM1QixNQUFJdkIsVUFBVWYsaUJBQUVvQyxTQUFGLENBQVlGLGNBQVosQ0FBZDtBQUNBbkIsWUFBVWYsaUJBQUV1QyxLQUFGLENBQVF4QixPQUFSLEVBQWlCdUIsS0FBakIsQ0FBVjtBQUNBdkIsVUFBUWpDLFNBQVIsQ0FBa0IwRCxRQUFsQixHQUE2QnpCLFFBQVFwQyxTQUFyQztBQUNBLFNBQU9vQyxPQUFQO0FBQ0Q7O0FBRUQsU0FBU0MsY0FBVCxDQUF3QjVDLEVBQXhCLEVBQTRCckIsR0FBNUIsRUFBaUM7QUFDL0IsU0FBT2lELGlCQUFFQyxJQUFGLENBQU9sRCxJQUFJcUMsU0FBSixDQUFjYyxXQUFyQixFQUFrQyxFQUFDdkIsV0FBV1AsR0FBR2lFLFFBQUgsRUFBWixFQUFsQyxDQUFQO0FBQ0QiLCJmaWxlIjoicGFuZWxfY3RybC5zcGVjLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7VHJpZ2dlclBhbmVsQ3RybH0gZnJvbSAnLi4vdHJpZ2dlcnNfcGFuZWxfY3RybCc7XG5pbXBvcnQge1BBTkVMX0RFRkFVTFRTLCBERUZBVUxUX1RBUkdFVH0gZnJvbSAnLi4vdHJpZ2dlcnNfcGFuZWxfY3RybCc7XG4vLyBpbXBvcnQgeyBjcmVhdGUgfSBmcm9tICdkb21haW4nO1xuXG5kZXNjcmliZSgnVHJpZ2dlclBhbmVsQ3RybCcsICgpID0+IHtcbiAgbGV0IGN0eCA9IHt9O1xuICBsZXQgZGF0YXNvdXJjZVNydk1vY2ssIHphYmJpeERTTW9jaztcbiAgbGV0IHRpbWVvdXRNb2NrID0gKCkgPT4ge307XG4gIGxldCBjcmVhdGVQYW5lbEN0cmw7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgY3R4ID0ge3Njb3BlOiB7cGFuZWw6IFBBTkVMX0RFRkFVTFRTfX07XG4gICAgemFiYml4RFNNb2NrID0ge1xuICAgICAgcmVwbGFjZVRlbXBsYXRlVmFyczogKCkgPT4ge30sXG4gICAgICB6YWJiaXg6IHtcbiAgICAgICAgZ2V0VHJpZ2dlcnM6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoW2dlbmVyYXRlVHJpZ2dlcihcIjFcIiksIGdlbmVyYXRlVHJpZ2dlcihcIjFcIildKSxcbiAgICAgICAgZ2V0QWNrbm93bGVkZ2VzOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKFByb21pc2UucmVzb2x2ZShbXSkpXG4gICAgICB9XG4gICAgfTtcblxuICAgIGRhdGFzb3VyY2VTcnZNb2NrID0ge1xuICAgICAgZ2V0TWV0cmljU291cmNlczogKCkgPT4ge1xuICAgICAgICByZXR1cm4gW1xuICAgICAgICAgIHsgbWV0YToge2lkOiAnYWxleGFuZGVyem9ibmluLXphYmJpeC1kYXRhc291cmNlJ30sIHZhbHVlOiB7fSwgbmFtZTogJ3phYmJpeF9kZWZhdWx0JyB9LFxuICAgICAgICAgIHsgbWV0YToge2lkOiAnYWxleGFuZGVyem9ibmluLXphYmJpeC1kYXRhc291cmNlJ30sIHZhbHVlOiB7fSwgbmFtZTogJ3phYmJpeCcgfSxcbiAgICAgICAgICB7IG1ldGE6IHtpZDogJ2dyYXBoaXRlJ30sIHZhbHVlOiB7fSwgbmFtZTogJ2dyYXBoaXRlJyB9LFxuICAgICAgICBdO1xuICAgICAgfSxcbiAgICAgIGdldDogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHphYmJpeERTTW9jaylcbiAgICB9O1xuICAgIGNyZWF0ZVBhbmVsQ3RybCA9ICgpID0+IG5ldyBUcmlnZ2VyUGFuZWxDdHJsKGN0eC5zY29wZSwge30sIHRpbWVvdXRNb2NrLCBkYXRhc291cmNlU3J2TW9jaywge30sIHt9LCB7fSk7XG5cbiAgICBjb25zdCBnZXRUcmlnZ2Vyc1Jlc3AgPSBbXG4gICAgICBbXG4gICAgICAgIGNyZWF0ZVRyaWdnZXIoe1xuICAgICAgICAgIHRyaWdnZXJpZDogXCIxXCIsIGxhc3RjaGFuZ2U6IFwiMTUxMDAwMDAxMFwiLCBwcmlvcml0eTogNSwgbGFzdEV2ZW50OiB7ZXZlbnRpZDogXCIxMVwifSwgaG9zdHM6IFt7bWFpbnRlbmFuY2Vfc3RhdHVzOiAnMSd9XVxuICAgICAgICB9KSxcbiAgICAgICAgY3JlYXRlVHJpZ2dlcih7XG4gICAgICAgICAgdHJpZ2dlcmlkOiBcIjJcIiwgbGFzdGNoYW5nZTogXCIxNTEwMDAwMDQwXCIsIHByaW9yaXR5OiAzLCBsYXN0RXZlbnQ6IHtldmVudGlkOiBcIjEyXCJ9XG4gICAgICAgIH0pLFxuICAgICAgXSxcbiAgICAgIFtcbiAgICAgICAgY3JlYXRlVHJpZ2dlcih7dHJpZ2dlcmlkOiBcIjNcIiwgbGFzdGNoYW5nZTogXCIxNTEwMDAwMDIwXCIsIHByaW9yaXR5OiA0LCBsYXN0RXZlbnQ6IHtldmVudGlkOiBcIjEzXCJ9fSksXG4gICAgICAgIGNyZWF0ZVRyaWdnZXIoe3RyaWdnZXJpZDogXCI0XCIsIGxhc3RjaGFuZ2U6IFwiMTUxMDAwMDAzMFwiLCBwcmlvcml0eTogMiwgbGFzdEV2ZW50OiB7ZXZlbnRpZDogXCIxNFwifX0pLFxuICAgICAgXVxuICAgIF07XG5cbiAgICAvLyBTaW11bGF0ZSAyIGRhdGEgc291cmNlc1xuICAgIHphYmJpeERTTW9jay56YWJiaXguZ2V0VHJpZ2dlcnMgPSBqZXN0LmZuKClcbiAgICAgIC5tb2NrUmV0dXJuVmFsdWVPbmNlKGdldFRyaWdnZXJzUmVzcFswXSlcbiAgICAgIC5tb2NrUmV0dXJuVmFsdWVPbmNlKGdldFRyaWdnZXJzUmVzcFsxXSk7XG4gICAgemFiYml4RFNNb2NrLnphYmJpeC5nZXRBY2tub3dsZWRnZXMgPSBqZXN0LmZuKClcbiAgICAgIC5tb2NrUmV0dXJuVmFsdWUoUHJvbWlzZS5yZXNvbHZlKFtkZWZhdWx0RXZlbnRdKSk7XG5cbiAgICBjdHgucGFuZWxDdHJsID0gY3JlYXRlUGFuZWxDdHJsKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdXaGVuIGFkZGluZyBuZXcgcGFuZWwnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzdWdnZXN0IGFsbCB6YWJiaXggZGF0YSBzb3VyY2VzJywgKCkgPT4ge1xuICAgICAgY3R4LnNjb3BlLnBhbmVsID0ge307XG4gICAgICBsZXQgcGFuZWxDdHJsID0gY3JlYXRlUGFuZWxDdHJsKCk7XG4gICAgICBleHBlY3QocGFuZWxDdHJsLmF2YWlsYWJsZV9kYXRhc291cmNlcykudG9FcXVhbChbXG4gICAgICAgICd6YWJiaXhfZGVmYXVsdCcsICd6YWJiaXgnXG4gICAgICBdKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgbG9hZCBmaXJzdCB6YWJiaXggZGF0YSBzb3VyY2UgYXMgZGVmYXVsdCcsICgpID0+IHtcbiAgICAgIGN0eC5zY29wZS5wYW5lbCA9IHt9O1xuICAgICAgbGV0IHBhbmVsQ3RybCA9IGNyZWF0ZVBhbmVsQ3RybCgpO1xuICAgICAgZXhwZWN0KHBhbmVsQ3RybC5wYW5lbC5kYXRhc291cmNlcykudG9FcXVhbChbXG4gICAgICAgICd6YWJiaXhfZGVmYXVsdCdcbiAgICAgIF0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnV2hlbiByZWZyZXNoaW5nIHBhbmVsJywgKCkgPT4ge1xuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgY3R4LnNjb3BlLnBhbmVsLmRhdGFzb3VyY2VzID0gWyd6YWJiaXhfZGVmYXVsdCcsICd6YWJiaXgnXTtcbiAgICAgIGN0eC5zY29wZS5wYW5lbC50YXJnZXRzID0ge1xuICAgICAgICAnemFiYml4X2RlZmF1bHQnOiBERUZBVUxUX1RBUkdFVCxcbiAgICAgICAgJ3phYmJpeCc6IERFRkFVTFRfVEFSR0VUXG4gICAgICB9O1xuICAgICAgY3R4LnBhbmVsQ3RybCA9IGNyZWF0ZVBhbmVsQ3RybCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBmb3JtYXQgdHJpZ2dlcnMnLCAoZG9uZSkgPT4ge1xuICAgICAgY3R4LnBhbmVsQ3RybC5vblJlZnJlc2goKS50aGVuKCgpID0+IHtcbiAgICAgICAgbGV0IGZvcm1hdHRlZFRyaWdnZXIgPSBfLmZpbmQoY3R4LnBhbmVsQ3RybC50cmlnZ2VyTGlzdCwge3RyaWdnZXJpZDogXCIxXCJ9KTtcbiAgICAgICAgZXhwZWN0KGZvcm1hdHRlZFRyaWdnZXIuaG9zdCkudG9CZSgnYmFja2VuZDAxJyk7XG4gICAgICAgIGV4cGVjdChmb3JtYXR0ZWRUcmlnZ2VyLmhvc3RUZWNoTmFtZSkudG9CZSgnYmFja2VuZDAxX3RlY2gnKTtcbiAgICAgICAgZXhwZWN0KGZvcm1hdHRlZFRyaWdnZXIuZGF0YXNvdXJjZSkudG9CZSgnemFiYml4X2RlZmF1bHQnKTtcbiAgICAgICAgZXhwZWN0KGZvcm1hdHRlZFRyaWdnZXIuc2V2ZXJpdHkpLnRvQmUoJ0Rpc2FzdGVyJyk7XG4gICAgICAgIGV4cGVjdChmb3JtYXR0ZWRUcmlnZ2VyLm1haW50ZW5hbmNlKS50b0JlKHRydWUpO1xuICAgICAgICBleHBlY3QoZm9ybWF0dGVkVHJpZ2dlci5hZ2UpLnRvQmVUcnV0aHkoKTtcbiAgICAgICAgZXhwZWN0KGZvcm1hdHRlZFRyaWdnZXIubGFzdGNoYW5nZSkudG9CZVRydXRoeSgpO1xuICAgICAgICBkb25lKCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgc29ydCB0cmlnZ2VycyBieSB0aW1lIGJ5IGRlZmF1bHQnLCAoZG9uZSkgPT4ge1xuICAgICAgY3R4LnBhbmVsQ3RybC5vblJlZnJlc2goKS50aGVuKCgpID0+IHtcbiAgICAgICAgbGV0IHRyaWdnZXJfaWRzID0gXy5tYXAoY3R4LnBhbmVsQ3RybC50cmlnZ2VyTGlzdCwgJ3RyaWdnZXJpZCcpO1xuICAgICAgICBleHBlY3QodHJpZ2dlcl9pZHMpLnRvRXF1YWwoW1xuICAgICAgICAgICcyJywgJzQnLCAnMycsICcxJ1xuICAgICAgICBdKTtcbiAgICAgICAgZG9uZSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHNvcnQgdHJpZ2dlcnMgYnkgc2V2ZXJpdHknLCAoZG9uZSkgPT4ge1xuICAgICAgY3R4LnBhbmVsQ3RybC5wYW5lbC5zb3J0VHJpZ2dlcnNCeSA9IHsgdGV4dDogJ3NldmVyaXR5JywgdmFsdWU6ICdwcmlvcml0eScgfTtcbiAgICAgIGN0eC5wYW5lbEN0cmwub25SZWZyZXNoKCkudGhlbigoKSA9PiB7XG4gICAgICAgIGxldCB0cmlnZ2VyX2lkcyA9IF8ubWFwKGN0eC5wYW5lbEN0cmwudHJpZ2dlckxpc3QsICd0cmlnZ2VyaWQnKTtcbiAgICAgICAgZXhwZWN0KHRyaWdnZXJfaWRzKS50b0VxdWFsKFtcbiAgICAgICAgICAnMScsICczJywgJzInLCAnNCdcbiAgICAgICAgXSk7XG4gICAgICAgIGRvbmUoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBhZGQgYWNrbm93bGVkZ2VzIHRvIHRyaWdnZXInLCAoZG9uZSkgPT4ge1xuICAgICAgY3R4LnBhbmVsQ3RybC5vblJlZnJlc2goKS50aGVuKCgpID0+IHtcbiAgICAgICAgbGV0IHRyaWdnZXIgPSBnZXRUcmlnZ2VyQnlJZCgxLCBjdHgpO1xuICAgICAgICBleHBlY3QodHJpZ2dlci5hY2tub3dsZWRnZXMpLnRvSGF2ZUxlbmd0aCgxKTtcbiAgICAgICAgZXhwZWN0KHRyaWdnZXIuYWNrbm93bGVkZ2VzWzBdLm1lc3NhZ2UpLnRvQmUoXCJldmVudCBhY2tcIik7XG5cbiAgICAgICAgZXhwZWN0KGdldFRyaWdnZXJCeUlkKDIsIGN0eCkuYWNrbm93bGVkZ2VzKS50b0JlKHVuZGVmaW5lZCk7XG4gICAgICAgIGV4cGVjdChnZXRUcmlnZ2VyQnlJZCgzLCBjdHgpLmFja25vd2xlZGdlcykudG9CZSh1bmRlZmluZWQpO1xuICAgICAgICBleHBlY3QoZ2V0VHJpZ2dlckJ5SWQoNCwgY3R4KS5hY2tub3dsZWRnZXMpLnRvQmUodW5kZWZpbmVkKTtcbiAgICAgICAgZG9uZSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdXaGVuIGZvcm1hdHRpbmcgdHJpZ2dlcnMnLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICBjdHgucGFuZWxDdHJsID0gY3JlYXRlUGFuZWxDdHJsKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBuZXcgbGluZXMgaW4gdHJpZ2dlciBkZXNjcmlwdGlvbicsICgpID0+IHtcbiAgICAgIGN0eC5wYW5lbEN0cmwuc2V0VHJpZ2dlclNldmVyaXR5ID0gamVzdC5mbigodHJpZ2dlcikgPT4gdHJpZ2dlcik7XG4gICAgICBsZXQgdHJpZ2dlciA9IHtjb21tZW50czogXCJ0aGlzIGlzXFxuZGVzY3JpcHRpb25cIn07XG4gICAgICBjb25zdCBmb3JtYXR0ZWRUcmlnZ2VyID0gY3R4LnBhbmVsQ3RybC5mb3JtYXRUcmlnZ2VyKHRyaWdnZXIpO1xuICAgICAgZXhwZWN0KGZvcm1hdHRlZFRyaWdnZXIuY29tbWVudHMpLnRvQmUoXCJ0aGlzIGlzPGJyPmRlc2NyaXB0aW9uXCIpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBmb3JtYXQgaG9zdCBuYW1lIHRvIGRpc3BsYXkgKGRlZmF1bHQpJywgKGRvbmUpID0+IHtcbiAgICAgIGN0eC5wYW5lbEN0cmwub25SZWZyZXNoKCkudGhlbigoKSA9PiB7XG4gICAgICAgIGxldCB0cmlnZ2VyID0gZ2V0VHJpZ2dlckJ5SWQoMSwgY3R4KTtcbiAgICAgICAgbGV0IGhvc3RuYW1lID0gY3R4LnBhbmVsQ3RybC5mb3JtYXRIb3N0TmFtZSh0cmlnZ2VyKTtcbiAgICAgICAgZXhwZWN0KGhvc3RuYW1lKS50b0JlKCdiYWNrZW5kMDEnKTtcbiAgICAgICAgZG9uZSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGZvcm1hdCBob3N0IG5hbWUgdG8gZGlzcGxheSAodGVjaCBuYW1lKScsIChkb25lKSA9PiB7XG4gICAgICBjdHgucGFuZWxDdHJsLnBhbmVsLmhvc3RGaWVsZCA9IGZhbHNlO1xuICAgICAgY3R4LnBhbmVsQ3RybC5wYW5lbC5ob3N0VGVjaE5hbWVGaWVsZCA9IHRydWU7XG4gICAgICBjdHgucGFuZWxDdHJsLm9uUmVmcmVzaCgpLnRoZW4oKCkgPT4ge1xuICAgICAgICBsZXQgdHJpZ2dlciA9IGdldFRyaWdnZXJCeUlkKDEsIGN0eCk7XG4gICAgICAgIGxldCBob3N0bmFtZSA9IGN0eC5wYW5lbEN0cmwuZm9ybWF0SG9zdE5hbWUodHJpZ2dlcik7XG4gICAgICAgIGV4cGVjdChob3N0bmFtZSkudG9CZSgnYmFja2VuZDAxX3RlY2gnKTtcbiAgICAgICAgZG9uZSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGZvcm1hdCBob3N0IG5hbWUgdG8gZGlzcGxheSAoYm90aCB0ZWNoIGFuZCB2aXNpYmxlKScsIChkb25lKSA9PiB7XG4gICAgICBjdHgucGFuZWxDdHJsLnBhbmVsLmhvc3RGaWVsZCA9IHRydWU7XG4gICAgICBjdHgucGFuZWxDdHJsLnBhbmVsLmhvc3RUZWNoTmFtZUZpZWxkID0gdHJ1ZTtcbiAgICAgIGN0eC5wYW5lbEN0cmwub25SZWZyZXNoKCkudGhlbigoKSA9PiB7XG4gICAgICAgIGxldCB0cmlnZ2VyID0gZ2V0VHJpZ2dlckJ5SWQoMSwgY3R4KTtcbiAgICAgICAgbGV0IGhvc3RuYW1lID0gY3R4LnBhbmVsQ3RybC5mb3JtYXRIb3N0TmFtZSh0cmlnZ2VyKTtcbiAgICAgICAgZXhwZWN0KGhvc3RuYW1lKS50b0JlKCdiYWNrZW5kMDEgKGJhY2tlbmQwMV90ZWNoKScpO1xuICAgICAgICBkb25lKCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGlkZSBob3N0bmFtZSBpZiBib3RoIHZpc2libGUgYW5kIHRlY2ggbmFtZSBjaGVja2JveGVzIHVuc2V0JywgKGRvbmUpID0+IHtcbiAgICAgIGN0eC5wYW5lbEN0cmwucGFuZWwuaG9zdEZpZWxkID0gZmFsc2U7XG4gICAgICBjdHgucGFuZWxDdHJsLnBhbmVsLmhvc3RUZWNoTmFtZUZpZWxkID0gZmFsc2U7XG4gICAgICBjdHgucGFuZWxDdHJsLm9uUmVmcmVzaCgpLnRoZW4oKCkgPT4ge1xuICAgICAgICBsZXQgdHJpZ2dlciA9IGdldFRyaWdnZXJCeUlkKDEsIGN0eCk7XG4gICAgICAgIGxldCBob3N0bmFtZSA9IGN0eC5wYW5lbEN0cmwuZm9ybWF0SG9zdE5hbWUodHJpZ2dlcik7XG4gICAgICAgIGV4cGVjdChob3N0bmFtZSkudG9CZShcIlwiKTtcbiAgICAgICAgZG9uZSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdXaGVuIGZvcm1hdHRpbmcgYWNrbm93bGVkZ2VzJywgKCkgPT4ge1xuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgY3R4LnBhbmVsQ3RybCA9IGNyZWF0ZVBhbmVsQ3RybCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBidWlsZCBwcm9wZXIgdXNlciBuYW1lJywgKCkgPT4ge1xuICAgICAgY29uc3QgYWNrID0ge1xuICAgICAgICBhbGlhczogJ2FsaWFzJywgIG5hbWU6ICduYW1lJywgc3VybmFtZTogJ3N1cm5hbWUnXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBmb3JtYXR0ZWQgPSBjdHgucGFuZWxDdHJsLmZvcm1hdEFja25vd2xlZGdlKGFjayk7XG4gICAgICBleHBlY3QoZm9ybWF0dGVkLnVzZXIpLnRvQmUoJ2FsaWFzIChuYW1lIHN1cm5hbWUpJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBlbXB0eSBuYW1lIGlmIGl0IGlzIG5vdCBkZWZpbmVkJywgKCkgPT4ge1xuICAgICAgY29uc3QgZm9ybWF0dGVkID0gY3R4LnBhbmVsQ3RybC5mb3JtYXRBY2tub3dsZWRnZSh7fSk7XG4gICAgICBleHBlY3QoZm9ybWF0dGVkLnVzZXIpLnRvQmUoJycpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuXG5jb25zdCBkZWZhdWx0VHJpZ2dlciA9IHtcbiAgXCJ0cmlnZ2VyaWRcIjogXCIxMzU2NVwiLFxuICBcInZhbHVlXCI6IFwiMVwiLFxuICBcImdyb3Vwc1wiOiBbe1wiZ3JvdXBpZFwiOiBcIjFcIiwgXCJuYW1lXCI6IFwiQmFja2VuZFwifV0gLFxuICBcImhvc3RzXCI6IFt7XCJob3N0XCI6IFwiYmFja2VuZDAxX3RlY2hcIiwgXCJob3N0aWRcIjogXCIxMDAwMVwiLFwibWFpbnRlbmFuY2Vfc3RhdHVzXCI6IFwiMFwiLCBcIm5hbWVcIjogXCJiYWNrZW5kMDFcIn1dICxcbiAgXCJsYXN0RXZlbnRcIjoge1xuICAgIFwiZXZlbnRpZFwiOiBcIjExXCIsXG4gICAgXCJjbG9ja1wiOiBcIjE1MDcyMjkwNjRcIixcbiAgICBcIm5zXCI6IFwiNTU2MjAyMDM3XCIsXG4gICAgXCJhY2tub3dsZWRnZWRcIjogXCIxXCIsXG4gICAgXCJ2YWx1ZVwiOiBcIjFcIixcbiAgICBcIm9iamVjdFwiOiBcIjBcIixcbiAgICBcInNvdXJjZVwiOiBcIjBcIixcbiAgICBcIm9iamVjdGlkXCI6IFwiMTM1NjVcIixcbiAgfSxcbiAgXCJ0YWdzXCI6IFtdICxcbiAgXCJsYXN0Y2hhbmdlXCI6IFwiMTQ0MDI1OTUzMFwiLFxuICBcInByaW9yaXR5XCI6IFwiMlwiLFxuICBcImRlc2NyaXB0aW9uXCI6IFwiTGFjayBvZiBmcmVlIHN3YXAgc3BhY2Ugb24gc2VydmVyXCIsXG4gIFwiY29tbWVudHNcIjogXCJJdCBwcm9iYWJseSBtZWFucyB0aGF0IHRoZSBzeXN0ZW1zIHJlcXVpcmVzXFxubW9yZSBwaHlzaWNhbCBtZW1vcnkuXCIsXG4gIFwidXJsXCI6IFwiaHR0cHM6Ly9ob3N0LmxvY2FsL3BhdGhcIixcbiAgXCJ0ZW1wbGF0ZWlkXCI6IFwiMFwiLCBcImV4cHJlc3Npb25cIjogXCJ7MTMxNzR9PDUwXCIsIFwibWFudWFsX2Nsb3NlXCI6IFwiMFwiLCBcImNvcnJlbGF0aW9uX21vZGVcIjogXCIwXCIsXG4gIFwiY29ycmVsYXRpb25fdGFnXCI6IFwiXCIsIFwicmVjb3ZlcnlfbW9kZVwiOiBcIjBcIiwgXCJyZWNvdmVyeV9leHByZXNzaW9uXCI6IFwiXCIsIFwic3RhdGVcIjogXCIwXCIsIFwic3RhdHVzXCI6IFwiMFwiLFxuICBcImZsYWdzXCI6IFwiMFwiLCBcInR5cGVcIjogXCIwXCIsIFwiaXRlbXNcIjogW10gLCBcImVycm9yXCI6IFwiXCJcbn07XG5cbmNvbnN0IGRlZmF1bHRFdmVudCA9IHtcbiAgXCJldmVudGlkXCI6IFwiMTFcIixcbiAgXCJhY2tub3dsZWRnZXNcIjogW1xuICAgIHtcbiAgICAgIFwiYWNrbm93bGVkZ2VpZFwiOiBcIjE4NVwiLFxuICAgICAgXCJhY3Rpb25cIjogXCIwXCIsXG4gICAgICBcImFsaWFzXCI6IFwiYXBpXCIsXG4gICAgICBcImNsb2NrXCI6IFwiMTUxMjM4MjI0NlwiLFxuICAgICAgXCJldmVudGlkXCI6IFwiMTFcIixcbiAgICAgIFwibWVzc2FnZVwiOiBcImV2ZW50IGFja1wiLFxuICAgICAgXCJuYW1lXCI6IFwiYXBpXCIsXG4gICAgICBcInN1cm5hbWVcIjogXCJ1c2VyXCIsXG4gICAgICBcInVzZXJpZFwiOiBcIjNcIlxuICAgIH1cbiAgXSxcbiAgXCJjbG9ja1wiOiBcIjE1MDcyMjkwNjRcIixcbiAgXCJuc1wiOiBcIjU1NjIwMjAzN1wiLFxuICBcImFja25vd2xlZGdlZFwiOiBcIjFcIixcbiAgXCJ2YWx1ZVwiOiBcIjFcIixcbiAgXCJvYmplY3RcIjogXCIwXCIsXG4gIFwic291cmNlXCI6IFwiMFwiLFxuICBcIm9iamVjdGlkXCI6IFwiMVwiLFxufTtcblxuZnVuY3Rpb24gZ2VuZXJhdGVUcmlnZ2VyKGlkLCB0aW1lc3RhbXAsIHNldmVyaXR5KSB7XG4gIGxldCB0cmlnZ2VyID0gXy5jbG9uZURlZXAoZGVmYXVsdFRyaWdnZXIpO1xuICB0cmlnZ2VyLnRyaWdnZXJpZCA9IGlkLnRvU3RyaW5nKCk7XG4gIGlmIChzZXZlcml0eSkge1xuICAgIHRyaWdnZXIucHJpb3JpdHkgPSBzZXZlcml0eS50b1N0cmluZygpO1xuICB9XG4gIGlmICh0aW1lc3RhbXApIHtcbiAgICB0cmlnZ2VyLmxhc3RjaGFuZ2UgPSB0aW1lc3RhbXA7XG4gIH1cbiAgcmV0dXJuIHRyaWdnZXI7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVRyaWdnZXIocHJvcHMpIHtcbiAgbGV0IHRyaWdnZXIgPSBfLmNsb25lRGVlcChkZWZhdWx0VHJpZ2dlcik7XG4gIHRyaWdnZXIgPSBfLm1lcmdlKHRyaWdnZXIsIHByb3BzKTtcbiAgdHJpZ2dlci5sYXN0RXZlbnQub2JqZWN0aWQgPSB0cmlnZ2VyLnRyaWdnZXJpZDtcbiAgcmV0dXJuIHRyaWdnZXI7XG59XG5cbmZ1bmN0aW9uIGdldFRyaWdnZXJCeUlkKGlkLCBjdHgpIHtcbiAgcmV0dXJuIF8uZmluZChjdHgucGFuZWxDdHJsLnRyaWdnZXJMaXN0LCB7dHJpZ2dlcmlkOiBpZC50b1N0cmluZygpfSk7XG59XG4iXX0=